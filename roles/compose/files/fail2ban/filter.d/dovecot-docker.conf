# Fail2Ban filter for dovecot running in Docker containers
# This filter handles the nested log format where Docker logs contain
# both the container timestamp and the inner dovecot timestamp

[INCLUDES]
before = common.conf

[Definition]

# Match the full Docker dovecot log format directly
# Format: Aug 19 16:41:57 green dovecot[621]: Aug 19 14:41:57 imap-login: Login attempt failed...
failregex = ^%(__prefix_line)s(?:dovecot\[\d+\]:\s+)?(?:\w{3}\s+\d{1,2}\s+\d{2}:\d{2}:\d{2}\s+)?(?:imap|pop3|managesieve)-login:\s+.*(?:authentication failure|auth failed|login failed|invalid credentials).*rip=<HOST>
            ^%(__prefix_line)s(?:dovecot\[\d+\]:\s+)?(?:\w{3}\s+\d{1,2}\s+\d{2}:\d{2}:\d{2}\s+)?auth.*:\s+.*authentication failure.*rip=<HOST>
            ^%(__prefix_line)s(?:dovecot\[\d+\]:\s+)?(?:\w{3}\s+\d{1,2}\s+\d{2}:\d{2}:\d{2}\s+)?(?:imap|pop3|managesieve)-login:\s+.*Aborted login \(auth failed.*rip=<HOST>
            ^%(__prefix_line)s(?:dovecot\[\d+\]:\s+)?(?:\w{3}\s+\d{1,2}\s+\d{2}:\d{2}:\d{2}\s+)?(?:imap|pop3|managesieve)-login:\s+.*Aborted login \(tried to use (?:disabled|disallowed).*rip=<HOST>

# Ignore successful authentications and legitimate disconnections
ignoreregex = ^%(__prefix_line)s(?:dovecot\[\d+\]:\s+)?(?:\w{3}\s+\d{1,2}\s+\d{2}:\d{2}:\d{2}\s+)?.*Login:.*rip=
              ^%(__prefix_line)s(?:dovecot\[\d+\]:\s+)?(?:\w{3}\s+\d{1,2}\s+\d{2}:\d{2}:\d{2}\s+)?.*Logged out.*rip=
